<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Real - OTP Dev API</title>
    <style>
        /* (Copy style dari HTML lo sebelumnya, biar sama) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .header {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .logo {
            font-size: 50px;
            margin-bottom: 15px;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .subtitle {
            opacity: 0.9;
            font-size: 16px;
        }
        .warning-box {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            margin: 20px;
            padding: 15px;
            border-radius: 8px;
            color: #856404;
            font-size: 14px;
        }
        .content {
            padding: 30px;
        }
        .step {
            margin-bottom: 30px;
        }
        .step-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        .phone-input {
            display: flex;
            gap: 10px;
        }
        .country-code {
            flex: 0 0 100px;
        }
        select, input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        .btn {
            width: 100%;
            padding: 18px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #1da851;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .otp-display {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-top: 20px;
            border: 2px dashed #25D366;
            display: none;
        }
        .otp-label {
            color: #666;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .otp-code {
            font-size: 48px;
            font-weight: bold;
            letter-spacing: 15px;
            color: #25D366;
            margin: 20px 0;
            font-family: monospace;
        }
        .timer {
            font-size: 18px;
            color: #666;
            margin: 15px 0;
        }
        .timer-number {
            font-weight: bold;
            color: #ff6b6b;
        }
        .verification-box {
            margin-top: 20px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 10px;
            display: none;
        }
        .verification-success {
            color: #2e7d32;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .simulation-log {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .log-entry {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            font-family: monospace;
        }
        .log-success { color: #2e7d32; }
        .log-error { color: #c62828; }
        .log-info { color: #1565c0; }
        .footer {
            text-align: center;
            padding: 20px;
            color: #777;
            font-size: 14px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }
        @media (max-width: 600px) {
            .phone-input { flex-direction: column; }
            .otp-code { font-size: 36px; letter-spacing: 10px; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fab fa-whatsapp"></i>
            </div>
            <h1>OTP Real - OTP Dev</h1>
            <p class="subtitle">Mengirim OTP beneran via API</p>
        </div>
        
        <div class="warning-box">
            <strong><i class="fas fa-exclamation-triangle"></i> PERINGATAN:</strong>
            Ini akan mengirim OTP nyata ke nomor Anda menggunakan API OTP Dev. Pastikan nomor Anda aktif.
        </div>
        
        <div class="content">
            <!-- Step 1: Input Nomor -->
            <div class="step" id="step1">
                <div class="step-title">
                    Masukkan Nomor WhatsApp
                </div>
                <div class="form-group">
                    <label for="countryCode">Kode Negara</label>
                    <div class="phone-input">
                        <div class="country-code">
                            <select id="countryCode">
                                <option value="62">+62</option>
                                <option value="1">+1</option>
                                <option value="44">+44</option>
                                <option value="91">+91</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <input type="tel" id="phoneNumber" placeholder="81234567890" maxlength="15">
                        </div>
                    </div>
                </div>
                
                <button class="btn" id="requestOtpBtn">
                    <i class="fas fa-paper-plane"></i> Minta Kode OTP
                </button>
            </div>
            
            <!-- Step 2: OTP Display -->
            <div class="otp-display" id="otpDisplay">
                <div class="otp-label">Kode OTP dikirim ke:</div>
                <div id="targetNumber" style="font-weight: bold; margin-bottom: 20px;"></div>
                
                <div class="timer">
                    <i class="fas fa-clock"></i> 
                    Kode dikirim, cek HP Anda. <span id="countdown"></span>
                </div>
                
                <div class="form-group" style="margin-top: 25px;">
                    <label>Masukkan Kode OTP yang diterima</label>
                    <input type="text" id="otpInput" placeholder="6 digit kode" maxlength="6">
                    <button class="btn" id="verifyOtpBtn" style="margin-top: 15px;">
                        <i class="fas fa-check-circle"></i> Verifikasi OTP
                    </button>
                    <button class="btn" id="resendBtn" style="margin-top: 10px; background: #ff9800;">
                        <i class="fas fa-redo-alt"></i> Kirim Ulang
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Verification Result -->
            <div class="verification-box" id="verificationResult">
                <div class="verification-success" id="verificationMessage">
                    <i class="fas fa-check-circle"></i> Verifikasi Berhasil!
                </div>
                <p id="verifiedInfo"></p>
            </div>
            
            <!-- Log -->
            <div class="simulation-log">
                <div class="log-title">
                    <i class="fas fa-terminal"></i> Log Real
                </div>
                <div id="logEntries"></div>
            </div>
        </div>
        
        <div class="footer">
            <p>Menggunakan API OTP Dev | Key: 3431a35f... (disamarkan)</p>
        </div>
    </div>
    <script>
        // ========== KONFIGURASI ==========
        // GANTI DENGAN API KEY LO YANG ASLI (dari screenshot)
        const API_KEY = '3431a35fb8162f7f81f722d03e18330f'; // <-- GANTI SINI
        
        // Base URL API OTP Dev (cek dokumentasi mereka)
        const API_BASE = 'https://api.otp.dev/v1';
        
        // ========== ELEMEN DOM ==========
        const requestBtn = document.getElementById('requestOtpBtn');
        const otpDisplay = document.getElementById('otpDisplay');
        const verifyBtn = document.getElementById('verifyOtpBtn');
        const resendBtn = document.getElementById('resendBtn');
        const verificationResult = document.getElementById('verificationResult');
        const logEntries = document.getElementById('logEntries');
        const targetNumberSpan = document.getElementById('targetNumber');
        const countdownSpan = document.getElementById('countdown');
        const otpInput = document.getElementById('otpInput');
        const countryCode = document.getElementById('countryCode');
        const phoneNumber = document.getElementById('phoneNumber');
        
        // ========== STATE ==========
        let currentRequestId = null;
        let currentPhone = '';
        let timerInterval = null;
        let timeLeft = 300; // 5 menit
        
        // ========== FUNGSI LOG ==========
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString('id-ID', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            entry.textContent = `[${timestamp}] ${message}`;
            logEntries.prepend(entry);
        }
        
        // ========== FUNGSI FORMAT NOMOR ==========
        function formatPhone(countryCode, number) {
            const cleaned = number.replace(/\D/g, '');
            return `+${countryCode}${cleaned}`;
        }
        
        // ========== FUNGSI START TIMER ==========
        function startTimer(seconds) {
            if (timerInterval) clearInterval(timerInterval);
            timeLeft = seconds;
            updateTimer();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimer();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    countdownSpan.textContent = 'Kode kadaluarsa';
                }
            }, 1000);
        }
        function updateTimer() {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            countdownSpan.textContent = `Berlaku: ${mins}:${secs.toString().padStart(2,'0')}`;
        }
        
        // ========== FUNGSI KIRIM OTP ==========
        async function sendOTP(isResend = false) {
            const cc = countryCode.value;
            const num = phoneNumber.value.trim();
            if (!num) {
                alert('Masukkan nomor telepon!');
                return;
            }
            const phone = formatPhone(cc, num);
            currentPhone = phone;
            
            // Tampilkan loading di tombol
            requestBtn.disabled = true;
            requestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';
            if (isResend) {
                resendBtn.disabled = true;
                resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kirim ulang...';
            }
            
            addLog(`Mengirim OTP ke ${phone}...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/otp/send`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: phone,
                        channel: 'sms',
                        ttl: 300
                    })
                });
                
                const data = await response.json();
                addLog(`Response: ${response.status} ${JSON.stringify(data)}`, 'info');
                
                if (response.ok) {
                    // Sukses, simpan request_id
                    currentRequestId = data.request_id; // asumsikan ada field request_id
                    addLog(`OTP berhasil dikirim. Request ID: ${currentRequestId}`, 'success');
                    
                    // Tampilkan step2
                    otpDisplay.style.display = 'block';
                    verificationResult.style.display = 'none';
                    targetNumberSpan.textContent = phone;
                    startTimer(300); // 5 menit
                    
                    if (!isResend) {
                        // Hanya pertama kali
                        requestBtn.style.display = 'none';
                    } else {
                        resendBtn.disabled = false;
                        resendBtn.innerHTML = '<i class="fas fa-redo-alt"></i> Kirim Ulang';
                    }
                } else {
                    // Gagal
                    addLog(`Gagal: ${data.message || 'Unknown error'}`, 'error');
                    alert(`Gagal kirim OTP: ${data.message || 'Cek konsol'}`);
                    requestBtn.disabled = false;
                    requestBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Minta Kode OTP';
                    if (isResend) {
                        resendBtn.disabled = false;
                        resendBtn.innerHTML = '<i class="fas fa-redo-alt"></i> Kirim Ulang';
                    }
                }
            } catch (error) {
                addLog(`Error: ${error.message}`, 'error');
                alert('Network error. Mungkin CORS? Coba upload ke server.');
                requestBtn.disabled = false;
                requestBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Minta Kode OTP';
                if (isResend) {
                    resendBtn.disabled = false;
                    resendBtn.innerHTML = '<i class="fas fa-redo-alt"></i> Kirim Ulang';
                }
            }
        }
        
        // ========== FUNGSI VERIFIKASI OTP ==========
        async function verifyOTP() {
            const code = otpInput.value.trim();
            if (!code || code.length !== 6) {
                alert('Masukkan 6 digit kode');
                return;
            }
            if (!currentRequestId) {
                alert('Request ID tidak ditemukan. Minta OTP dulu!');
                return;
            }
            
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memverifikasi...';
            
            try {
                const response = await fetch(`${API_BASE}/otp/verify`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        request_id: currentRequestId,
                        code: code
                    })
                });
                
                const data = await response.json();
                addLog(`Verify response: ${response.status}`, 'info');
                
                if (response.ok && data.valid) { // asumsikan field valid
                    addLog('✅ Verifikasi sukses!', 'success');
                    verificationResult.style.display = 'block';
                    verificationResult.querySelector('#verificationMessage').innerHTML = '<i class="fas fa-check-circle"></i> Verifikasi Berhasil!';
                    verificationResult.querySelector('#verifiedInfo').innerHTML = `Nomor ${currentPhone} terverifikasi.`;
                    otpDisplay.style.display = 'none';
                    clearInterval(timerInterval);
                } else {
                    addLog('❌ Kode salah', 'error');
                    alert('Kode OTP salah!');
                }
            } catch (error) {
                addLog(`Error: ${error.message}`, 'error');
                alert('Network error saat verifikasi.');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verifikasi OTP';
            }
        }
        
        // ========== EVENT LISTENER ==========
        requestBtn.addEventListener('click', () => sendOTP(false));
        resendBtn.addEventListener('click', () => sendOTP(true));
        verifyBtn.addEventListener('click', verifyOTP);
        
        otpInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyOTP();
        });
        
        // ========== INIT LOG ==========
        addLog('Sistem siap. Masukkan nomor dan kirim OTP.', 'info');
        addLog(`Menggunakan API Key: ${API_KEY.slice(0,8)}...`, 'info');
    </script>
</body>
</html>
